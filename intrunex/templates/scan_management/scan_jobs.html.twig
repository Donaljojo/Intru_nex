{% extends 'base.html.twig' %}

{% block title %}Recent Scan Jobs{% endblock %}

{% block body %}
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">IntruNex</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="{{ path('dashboard') }}">Dashboard</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container-fluid mt-4">
    <h1>Recent Scan Jobs</h1>
    <a href="{{ path('dashboard') }}" class="btn btn-secondary mb-3">
        ‚Üê Back to Dashboard
    </a>
    <form method="post" action="{{ path('scan_job_delete_multiple') }}" onsubmit="return confirm('Are you sure you want to delete the selected scan jobs?');">
        <input type="hidden" name="_token" value="{{ csrf_token('delete_multiple_scans') }}">

        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all"></th>
                        <th>Asset</th>
                        <th>Status</th>
                        <th>Started At</th>
                        <th>Completed At</th>
                        <th>Error Message</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for scanJob in scanJobs %}
                    <tr>
                        <td><input type="checkbox" name="scan_job_ids[]" value="{{ scanJob.id }}" class="scan-job-checkbox"></td>
                        <td>{{ scanJob.asset.name }}</td>
                        <td>{{ scanJob.status|capitalize }}</td>
                        <td>{{ scanJob.startedAt ? scanJob.startedAt|date('Y-m-d H:i:s') : 'N/A' }}</td>
                        <td>{{ scanJob.finishedAt ? scanJob.finishedAt|date('Y-m-d H:i:s') : 'N/A' }}</td>
                        <td>{{ scanJob.errorMessage ?: '-' }}</td>
                        <td>
                            <a href="{{ path('scan_progress', {'id': scanJob.id}) }}" class="btn btn-sm btn-primary">View Progress</a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center">No scan jobs found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <button type="submit" class="btn btn-danger" id="delete-selected" disabled>Delete Selected</button>
    </form>
</div>

{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const selectAll = document.getElementById('select-all');
        const checkboxes = document.querySelectorAll('.scan-job-checkbox');
        const deleteSelectedBtn = document.getElementById('delete-selected');

        function toggleDeleteButton() {
            const anyChecked = Array.from(checkboxes).some(c => c.checked);
            deleteSelectedBtn.disabled = !anyChecked;
        }

        selectAll.addEventListener('change', function() {
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            toggleDeleteButton();
        });

        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const allChecked = Array.from(checkboxes).every(c => c.checked);
                selectAll.checked = allChecked;
                toggleDeleteButton();
            });
        });

        // Initial state
        toggleDeleteButton();
    });
</script>
{% endblock %}
