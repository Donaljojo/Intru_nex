<?php

namespace App\Modules\VulnerabilityDetection\MessageHandler;

use App\Modules\AssetDiscovery\Repository\AssetRepository;
use App\Modules\ScanManagement\Repository\ScanJobRepository;
use App\Modules\VulnerabilityDetection\Message\VulnerabilityScanMessage;
use App\Modules\VulnerabilityDetection\Service\ArachniScanService;
use App\Modules\VulnerabilityDetection\Service\NiktoScanService;
use App\Modules\VulnerabilityDetection\Service\NmapScanService;
use App\Modules\VulnerabilityDetection\Service\WapitiScanService;
use App\Modules\VulnerabilityDetection\Service\WhatwebScanService;
use Symfony\Component\Messenger\Attribute\AsMessageHandler;
use Psr\Log\LoggerInterface;
use Doctrine\ORM\EntityManagerInterface;

#[AsMessageHandler]
class VulnerabilityScanMessageHandler
{
    private AssetRepository $assetRepository;
    private ScanJobRepository $scanJobRepository;
    private NiktoScanService $niktoScanService;
    private NmapScanService $nmapScanService;
    private WapitiScanService $wapitiScanService;
    private ArachniScanService $arachniScanService;
    private WhatwebScanService $whatwebScanService;
    private LoggerInterface $logger;
    private EntityManagerInterface $em;

    public function __construct(
        AssetRepository $assetRepository,
        ScanJobRepository $scanJobRepository,
        NiktoScanService $niktoScanService,
        NmapScanService $nmapScanService,
        WapitiScanService $wapitiScanService,
        ArachniScanService $arachniScanService,
        WhatwebScanService $whatwebScanService,
        LoggerInterface $logger,
        EntityManagerInterface $em
    ) {
        $this->assetRepository = $assetRepository;
        $this->scanJobRepository = $scanJobRepository;
        $this->niktoScanService = $niktoScanService;
        $this->nmapScanService = $nmapScanService;
        $this->wapitiScanService = $wapitiScanService;
        $this->arachniScanService = $arachniScanService;
        $this->whatwebScanService = $whatwebScanService;
        $this->logger = $logger;
        $this->em = $em;
    }

    public function __invoke(VulnerabilityScanMessage $message)
    {
        $asset = $this->assetRepository->find($message->getAssetId());
        $scanJob = $this->scanJobRepository->find($message->getScanJobId());

        if (!$asset || !$scanJob) {
            $this->logger->error('Asset or ScanJob not found for message.', [
                'assetId' => $message->getAssetId(),
                'scanJobId' => $message->getScanJobId(),
            ]);
            return;
        }

        $scanJob->setStatus('running');
        $this->em->flush();

        try {
            $result = match ($message->getScanner()) {
                'nikto' => $this->niktoScanService->performScan($asset),
                'nmap' => $this->nmapScanService->performScan($asset),
                'wapiti' => $this->wapitiScanService->performScan($asset),
                'arachni' => $this->arachniScanService->performScan($asset),
                'whatweb' => $this->whatwebScanService->performScan($asset),
                default => throw new \InvalidArgumentException('Unknown scanner: ' . $message->getScanner()),
            };

            $scanJob->setStatus('completed');
            $scanJob->setFinishedAt(new \DateTimeImmutable());
            $scanJob->setResult(json_encode(['raw_output' => $result])); // Store raw output for now
            $this->em->flush();

            $this->logger->info(sprintf('Vulnerability scan completed for asset %d using %s.', $asset->getId(), $message->getScanner()));
        } catch (\Exception $e) {
            $scanJob->setStatus('failed');
            $scanJob->setFinishedAt(new \DateTimeImmutable());
            $scanJob->setErrorMessage($e->getMessage());
            $this->em->flush();

            $this->logger->error(sprintf('Vulnerability scan failed for asset %d using %s: %s', $asset->getId(), $message->getScanner(), $e->getMessage()));
        }
    }
}
