<?php

namespace App\Modules\VulnerabilityDetection\Controller;

use App\Modules\ScanManagement\Entity\ScanJob;
use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\Routing\Annotation\Route;
use Symfony\Component\Security\Http\Attribute\IsGranted;

#[Route('/vulnerability-scans')]
class VulnerabilityScanController extends AbstractController
{
    #[Route('/progress/{id}', name: 'vulnerability_scan_progress')]
    #[IsGranted('ROLE_USER')]
    public function scanProgress(ScanJob $scanJob): Response
    {
        // Ensure the user owns the asset being scanned
        if ($scanJob->getAsset()->getUser() !== $this->getUser()) {
            $this->addFlash('error', 'You are not authorized to view this scan.');
            return $this->redirectToRoute('dashboard');
        }

        return $this->render('@VulnerabilityDetection/scan_progress.html.twig', [
            'scanJob' => $scanJob,
        ]);
    }
}