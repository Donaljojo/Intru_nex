<?php

namespace App\Modules\VulnerabilityDetection\Controller;

use App\Modules\AssetDiscovery\Entity\Asset;
use App\Modules\ScanManagement\Entity\ScanJob;
use App\Modules\VulnerabilityDetection\Service\VulnerabilityScanService;
use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\Routing\Annotation\Route;
use Symfony\Component\Security\Http\Attribute\IsGranted;

#[Route('/vulnerability-scans')]
class VulnerabilityScanController extends AbstractController
{
    #[Route('/progress/{id}', name: 'vulnerability_scan_progress')]
    #[IsGranted('ROLE_USER')]
    public function scanProgress(ScanJob $scanJob): Response
    {
        // Ensure the user owns the asset being scanned
        if ($scanJob->getAsset()->getUser() !== $this->getUser()) {
            $this->addFlash('error', 'You are not authorized to view this scan.');
            return $this->redirectToRoute('dashboard');
        }

        return $this->render('VulnerabilityDetection/scan_progress.html.twig', [
            'scanJob' => $scanJob,
        ]);
    }

    #[Route('/trigger/{id}/{scanner}', name: 'vulnerability_scan_trigger')]
    #[IsGranted('ROLE_USER')]
    public function triggerScan(Asset $asset, string $scanner, VulnerabilityScanService $vulnerabilityScanService): Response
    {
        // Ensure the user owns the asset
        if ($asset->getUser() !== $this->getUser()) {
            $this->addFlash('error', 'You are not authorized to scan this asset.');
            return $this->redirectToRoute('dashboard');
        }

        $scanJob = $vulnerabilityScanService->scanAsset($asset, $scanner);

        $this->addFlash('success', sprintf('Vulnerability scan for %s using %s initiated.', $asset->getName(), $scanner));

        return $this->redirectToRoute('vulnerability_scan_progress', ['id' => $scanJob->getId()]);
    }
}